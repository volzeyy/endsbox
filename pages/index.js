import { useEffect, useState } from "react"
import Head from 'next/head'
import styles from '../styles/Home.module.css'

import { doc, getDoc } from "firebase/firestore"
import { db } from "../firebase"

import BoxWindow from "../components/BoxWindow"
import BoxActionBar from "../components/BoxActionBar"
import ContentWindow from "../components/ContentWindow"

import { useUserStore } from "../stores/userStore"

export default function Home() {

  const user = useUserStore((state) => state.user)
  
  const [boxObjects, setBoxObjects] = useState([])
  const [boxScale, setBoxScale] = useState(0.4)
  const [boxPositionX, setBoxPositionX] = useState(0)
  const [boxPositionY, setBoxPositionY] = useState(0)
  const [currentAction, setCurrentAction] = useState("pan")
  const [isShowUserSignup, setIsShowUserSignup] = useState(false)

  useEffect(() => {
    const fetchUser = async () => {
      if (user && !user.username) {
        const docRef = doc(db, "users", user.uid)
        const docSnap = await getDoc(docRef)

        if (docSnap.exists()) {
          const data = docSnap.data()
          console.log("Document data: ", data)
          useUserStore.getState().setUsername(docSnap.data().username)
        } else {
          setIsShowUserSignup(true)
        }
      }

      return () => {
        console.log("unmounted")
      }
    }

    fetchUser()
  }, [user])

  return (
    <div className={styles.container}>
      <Head>
        <title>eternebox</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {isShowUserSignup ?
        <ContentWindow>
          Hello
        </ContentWindow>
      :
      <>
        <BoxWindow 
          currentAction={currentAction} 
          boxObjects={boxObjects}
          setBoxObjects={setBoxObjects}
          boxScale={boxScale}
          boxPositionX={boxPositionX}
          setBoxPositionX={setBoxPositionX}
          boxPositionY={boxPositionY}
          setBoxPositionY={setBoxPositionY}
        />
        <BoxActionBar 
          currentAction={currentAction} 
          setCurrentAction={setCurrentAction} 
          setBoxObjects={setBoxObjects}
          boxPositionX={boxPositionX}
          boxPositionY={boxPositionY}
          setBoxScale={setBoxScale}
        />
      </>
      }
    </div>
  )
}
