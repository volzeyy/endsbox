import { useEffect, useState } from "react";
import Head from "next/head";

import { doc, getDoc } from "firebase/firestore";
import { db } from "../firebase";

import { MainContainer } from "../styles/Home.style";

import UserSignupForm from "../components/UserSignupForm";
import BoxView from "../components/BoxView";
import PropertyBar from "../components/PropertyBar";
import ToolBar from "../components/ToolBar";

import { useUserStore } from "../stores/userStore";
import { useToolStore } from "../stores/toolStore";

export default function Home() {
  const user = useUserStore((state) => state.user);
  const selectedTool = useToolStore((state) => state.selectedTool);

  const [box, setBox] = useState({
    owner: "",
    background: {
      position: {
        x: 0,
        y: 0,
      },
    },
    objects: [],
    scale: 0.2,
    position: { x: 0, y: 0 },
    selectedObjectId: "",
  });
  const [isShowUsernameSignup, setIsShowUsernameSignup] = useState(false);

  useEffect(() => {
    const fetchUser = async () => {
      if (user && !user.username) {
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          useUserStore.getState().setUsername(docSnap.data().username);
          setIsShowUsernameSignup(false);
          return;
        }
        setIsShowUsernameSignup(true);
        return;
      }

      setIsShowUsernameSignup(false);
    };

    fetchUser();
  }, [user]);

  return (
    <MainContainer
      toolbar={true}
    >
      <Head>
        <title>eternebox</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      {isShowUsernameSignup ? (
        <UserSignupForm />
      ) : (
        <>
          <BoxView box={box} setBox={setBox} />
          <PropertyBar box={box} setBox={setBox} show={box.selectedObjectId || selectedTool === "customize-box" ? true : false } />
          <ToolBar box={box} setBox={setBox} />
        </>
      )}
    </MainContainer>
  );
}
